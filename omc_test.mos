/*
 * A simple OpenModelica script to verify that MessagePack works correctly
 */

loadFile("MessagePack/package.mo");getErrorString();
mkdir("tmp");
cd("tmp");
setCFlags(getCFlags() + " -g");getErrorString();
loadString("function f
  input String file;
protected
  MessagePack.SimpleBuffer sbuffer = MessagePack.SimpleBuffer();
  MessagePack.Packer packer = MessagePack.Packer(sbuffer);
algorithm
  MessagePack.pack_integer(packer,-65538);
  MessagePack.pack_string(packer,\"OpenModelica\");
  MessagePack.pack_map(packer, 1);
  MessagePack.pack_double(packer,1.0);
  MessagePack.pack_bool(packer,true);
  MessagePack.pack_array(packer, 2);
  MessagePack.pack_integer(packer,65538);
  MessagePack.pack_double(packer,2.0);
  MessagePack.pack_bool(packer,false);
  print(String(MessagePack.pack_string(packer,\"OpenModelica\")));
  MessagePack.to_file(sbuffer,file);
end f;

function g
  input String file;
protected
  MessagePack.Deserializer deserializer = MessagePack.Deserializer(file);
  MessagePack.StringStream ss = MessagePack.StringStream();
  Integer offset = 0, i;
  String s;
  Boolean success;
algorithm
  (i,offset) := MessagePack.unpack_int(deserializer,offset);
  print(String(i) + \" offset: \" + String(offset) +\"\n\");
  (s,offset) := MessagePack.unpack_string(deserializer,offset);
  print(s + \" offset: \" + String(offset) +\"\n\");
  offset := MessagePack.unpack_any_to_stringstream(deserializer,ss,offset);
  print(MessagePack.stringstream_get(ss) + \" offset: \" + String(offset) +\"\n\");
  print(MessagePack.stringstream_get(ss) + \" offset: \" + String(offset) +\"\n\");
  success := true;
  while success loop
    (offset,success) := MessagePack.unpack_any_to_stringstream(deserializer,ss,offset);
    MessagePack.stringstream_append(ss,\"\n\");
  end while;
  print(MessagePack.stringstream_get(ss) + \"offset: \" + String(offset) +\"\n\");
end g;
");getErrorString();
system("rm -f out.msgpack");getErrorString();
f("out.msgpack");getErrorString();
system("ls -l out.msgpack");getErrorString();
g("out.msgpack");getErrorString();
